<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.7.1/dist/dotlottie-wc.js" type="module"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  </head>
  <body>
    <!-- Navbar -->
    <header class="navbar">
      <div class="navbar-left">
        <h1 class="app-title">💰 Expense Tracker</h1>
      </div>
      <button class="hamburger" id="hamburgerBtn">☰</button>
      <div class="navbar-right" id="navbarLinks">
        <!-- You can add future links or icons here -->
        <span class="nav-item">
          <a href="home.html" class="nav-item">Home</a>
        </span>
        <span class="nav-item">
          <a href="index.html" class="nav-item">Dashboard</a>
        </span>
        <button id="loginBtn" class="bg-white/10 border border-white/20 px-5 py-2 rounded-xl shadow-md 
      backdrop-blur-md text-white hover:bg-white/20 transition duration-300">Login </button>
      </div>
    </header>
    <!-- Loader (global, can reuse for both login & signup) -->
    <div id="loader" class="fixed inset-0 bg-black/50 backdrop-blur-md flex items-center justify-center hidden z-[9999]">
      <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
    <!-- Global Notification Popup -->
    <div id="notificationPopup" class="fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-md hidden z-[9999]">
      <div class="w-full max-w-md bg-white/10 border border-white/20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 text-center relative">
        <button id="closeNotification" class="absolute top-3 right-3 text-white text-2xl font-bold hover:text-gray-300 bg-transparent border-0 outline-none">&times;</button>
        <h2 id="notificationTitle" class="text-2xl font-bold text-white mb-3">Notification</h2>
        <p id="notificationMessage" class="text-gray-200 mb-5"></p>
        <button id="notificationOkBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">OK</button>
      </div>
    </div>
    <dotlottie-wc id="player" src="https://lottie.host/2f36c027-f8b2-4cb6-bdfe-cede7cfcca4a/CQWjr6Q3jg.lottie" loop autoplay class="lottie-background"></dotlottie-wc>
    <h1 class="main-logo">💰</h1>
    <h1 class="main-title">Expense Tracker</h1>
    <button class="get-started" id="getStartedBtn">Get Started</button>
    <!-- Login Popup -->
    <div id="loginPopup" class="fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-md 
  hidden z-50">
      <div class="popup-login w-full max-w-md bg-white/10 border border-white/20 backdrop-blur-lg rounded-2xl 
    shadow-2xl p-8 relative">
        <!-- Close Button -->
        <button id="closePopup" class="absolute top-3 right-3 text-white text-2xl font-bold hover:text-gray-300 bg-transparent border-0 outline-none hover:bg-transparent">&times;</button>
        <!-- Heading -->
        <h2 class="text-3xl font-bold text-center text-white drop-shadow-lg mb-6">Welcome Back 👋</h2>
        <p class="text-center text-gray-200 mb-8">Login to your account</p>
        <!-- Form -->
        <form id="loginForm" class="space-y-5">
          <div>
            <input type="text" id="username" placeholder="Username" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 
            focus:ring-2 focus:ring-blue-400 focus:outline-none" />
          </div>
          <div>
            <input type="password" id="password" placeholder="Password" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 
            focus:ring-2 focus:ring-blue-400 focus:outline-none" />
          </div>
          <button type="submit" class=" login-submit w-full bg-blue-700 text-white py-3 rounded-lg font-semibold hover:bg-blue-800 transition duration-300 font-bold"> Login </button>
        </form>
        <!-- Footer -->
        <p class="text-center text-gray-300 mt-6"> Don’t have an account? <a href="signup.html" id="openSignupFromLogin" class="text-blue-400 font-medium hover:underline">Sign Up</a>
        </p>
      </div>
    </div>
    <!-- Signup Popup -->
    <div id="signupPopup" class="fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-md hidden z-50">
      <div class="popup-signup w-full max-w-md bg-white/10 border border-white/20 backdrop-blur-lg rounded-2xl shadow-2xl p-8 relative">
        <!-- Close Button -->
        <button id="closeSignup" class="absolute top-3 right-3 text-white text-2xl font-bold bg-transparent border-0 outline-none hover:text-gray-300">&times;</button>
        <!-- Heading -->
        <h2 class="text-3xl font-bold text-center text-white drop-shadow-lg mb-6">Create Account</h2>
        <p class="text-center text-gray-200 mb-8">Manage all your expenses</p>
        <!-- Signup Form -->
        <form id="signupForm" class="space-y-4">
          <input type="text" id="signupUsername" placeholder="Username" required class="w-full px-4 py-3 border border-white/30 rounded-lg bg-white/20 text-white placeholder-gray-300 focus:ring-2 focus:ring-blue-400 focus:outline-none">
          <input type="password" id="signupPassword" placeholder="Password" required class="w-full px-4 py-3 border border-white/30 rounded-lg bg-white/20 text-white placeholder-gray-300 focus:ring-2 focus:ring-blue-400 focus:outline-none">
          <button type="submit" class="signup-submit w-full bg-blue-700 text-white py-3 rounded-lg font-semibold hover:bg-blue-800 transition duration-300"> Sign Up </button>
        </form>
        <!-- Redirect to Login -->
        <p class="mt-6 text-center text-gray-300"> Already have an account? <a href="#" id="openLoginFromSignup" class="text-blue-400 font-medium hover:underline">Login</a>
        </p>
      </div>
    </div>
    <script>
      const loginBtn = document.getElementById("loginBtn");
      const loginPopup = document.getElementById("loginPopup");
      const closePopup = document.getElementById("closePopup");
      const openSignupFromLogin = document.getElementById("openSignupFromLogin");
      const openLoginFromSignup = document.getElementById("openLoginFromSignup");
      if (openSignupFromLogin) {
        openSignupFromLogin.addEventListener("click", (e) => {
          e.preventDefault();
          loginPopup.classList.add("hidden"); // hide login
          signupPopup.classList.remove("hidden"); // show signup
        });
      }
      if (openLoginFromSignup) {
        openLoginFromSignup.addEventListener("click", (e) => {
          e.preventDefault();
          signupPopup.classList.add("hidden"); // hide signup
          loginPopup.classList.remove("hidden"); // show login
        });
      }
      loginBtn.addEventListener("click", () => {
        loginPopup.classList.remove("hidden");
      });
      closePopup.addEventListener("click", () => {
        loginPopup.classList.add("hidden");
      });
      loginPopup.addEventListener("click", (e) => {
        if (e.target === loginPopup) {
          loginPopup.classList.add("hidden");
        }
      });
      async function hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return CryptoJS.SHA256(password).toString(CryptoJS.enc.Hex);
      }
      document.getElementById("loginForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        // Hash the password
        const hashedPassword = hashPassword(password);
        // Show loader
        document.getElementById("loader").classList.remove("hidden");
        try {
          const res = await fetch("http://localhost:8081/api/users/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              username,
              password
            })
          });
          if (res.ok) {
  const user = await res.json();
  localStorage.setItem("userId", user.id);
  localStorage.setItem("username", user.username);
  showNotification(
    "Login Successful 🎉",
    `Welcome back, ${user.username}!`,
    () => {
      window.location.href = "index.html";
    }
  );
} else if (res.status === 403) {
  showNotification(
    "Account Deactivated ⚠️",
    "Your account has been deactivated. Please contact admin.",
    () => {
      localStorage.removeItem("userId");
      localStorage.removeItem("username");
    }
  );
} else {
  showNotification(
    "Login Failed ⚠️",
    "Invalid credentials. Please try again."
  );
}

        } catch (err) {
          showNotification("Server Error 🚨", "⚠️ Server not reachable, please try again later.");
          console.error(err);
        } finally {
          // Hide loader
          document.getElementById("loader").classList.add("hidden");
        }
      });
      const getStartedBtn = document.getElementById("getStartedBtn");
      const signupPopup = document.getElementById("signupPopup");
      const closeSignup = document.getElementById("closeSignup");
      // Show popup
      getStartedBtn.addEventListener("click", () => {
        signupPopup.classList.remove("hidden");
      });
      // Hide popup
      closeSignup.addEventListener("click", () => {
        signupPopup.classList.add("hidden");
      });
      // Hide if click outside card
      signupPopup.addEventListener("click", (e) => {
        if (e.target === signupPopup) {
          signupPopup.classList.add("hidden");
        }
      });
      // Handle signup request
      document.getElementById("signupForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("signupUsername").value;
        const password = document.getElementById("signupPassword").value;
        // Password validation
        if (password.length < 8) {
          showNotification("Weak Password ⚠️", "Password must be at least 8 characters long.");
          return;
        }
        // Hash the password
        const hashedPassword = hashPassword(password);
        // Show loader
        document.getElementById("loader").classList.remove("hidden");
        try {
          const res = await fetch("http://localhost:8081/api/users/signup", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              username,
              password
            })
          });
          if (res.ok) {
            showNotification("Signup Successful 🎉", "Please login to continue.", () => {
              signupPopup.classList.add("hidden");
              document.getElementById("loginPopup")?.classList.remove("hidden");
            });
          } else {
            showNotification("Signup Failed ⚠️", "Try another username.");
          }
        } catch (err) {
          showNotification("Server Error 🚨", "⚠️ Server not reachable, please try again later.");
          console.error(err);
        } finally {
          // Hide loader
          document.getElementById("loader").classList.add("hidden");
        }
      });
      window.addEventListener("DOMContentLoaded", () => {
        const openLoginPopup = localStorage.getItem("openLoginPopup");
        if (openLoginPopup === "true") {
          const loginPopup = document.getElementById("loginPopup");
          if (loginPopup) {
            loginPopup.classList.remove("hidden"); // show login popup
          }
          // Remove the flag so it doesn’t reopen on next reload
          localStorage.removeItem("openLoginPopup");
        }
      });
      const hamburgerBtn = document.getElementById("hamburgerBtn");
      const navbarLinks = document.getElementById("navbarLinks");
      hamburgerBtn.addEventListener("click", () => {
        navbarLinks.classList.toggle("active");
      });

      function showNotification(title, message, callback = null) {
        document.getElementById("notificationTitle").textContent = title;
        document.getElementById("notificationMessage").textContent = message;
        document.getElementById("notificationPopup").classList.remove("hidden");
        // Close handlers
        const closeHandler = () => {
          document.getElementById("notificationPopup").classList.add("hidden");
          if (callback) callback(); // Run extra action
        };
        document.getElementById("closeNotification").onclick = closeHandler;
        document.getElementById("notificationOkBtn").onclick = closeHandler;
      }
    </script>
  </body>
</html>