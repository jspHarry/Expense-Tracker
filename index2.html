<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.7.1/dist/dotlottie-wc.js" type="module"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Toastify CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <!-- Toastify JS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      .charts-container {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        gap: 40px;
        /* space between charts */
        flex-wrap: wrap;
        /* allow stacking on mobile */
        margin-top: 20px;
      }

      .chart-box {
        width: 450px;
        /* fixed width */
        border-radius: 12px;
        padding: 15px;
        margin-left: 200px;
        margin-bottom: 60px;
      }

      .chart-box canvas {
        width: 100% !important;
        height: 100% !important;
      }

      @media (min-width: 481px) and (max-width: 1024px) {
        .navbar-right {
          display: flex;
          top: 5%;
          right: -5%;
        }

        .profile-avatar {
          font-size: 3.5vw;
          width: 60px;
          height: 60px;
        }

        .navbar-right .nav-item {
          display: none;
        }

        .dropdown {
          margin-top: 40%;
        }

        #logoutBtn {
          font-size: 2.5vw;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <header class="navbar">
      <div class="navbar-left">
        <h1 class="app-title">üí∞ Expense Tracker</h1>
      </div>
      <div class="navbar-right">
        <!-- You can add future links or icons here -->
        <span class="nav-item">
          <a href="home.html" class="nav-item">Home</a>
        </span>
        <span class="nav-item">
          <a href="index.html" class="nav-item">Dashboard</a>
        </span>
        <div class="profile-container">
          <div class="profile-avatar" id="profile-avatar"></div>
          <div class="dropdown" id="dropdown">
            <button id="logoutBtn">Logout</button>
          </div>
        </div>
      </div>
      </div>
    </header>
    <!-- Logout Confirmation Modal -->
    <div class="modal" id="logout-modal">
      <div class="modal-content">
        <h3>Confirm Logout <img width="30" height="30" src="https://img.icons8.com/sf-black/64/FA5252/exit.png" alt="exit" />
        </h3>
        <p>Are you sure you want to log out?</p>
        <div class="modal-actions">
          <button id="logout-confirm-btn">Yes, Logout</button>
          <button id="logout-cancel-btn">Cancel</button>
        </div>
      </div>
    </div>
    <dotlottie-wc id="player" src="https://lottie.host/2f36c027-f8b2-4cb6-bdfe-cede7cfcca4a/CQWjr6Q3jg.lottie" loop autoplay class="lottie-background"></dotlottie-wc>
    <div class="container">
      <h1>üìä Stay on top of your finances</h1>
      <div class="view-graph-trigger" id="toggleCharts"> üìä View Graphical Representation </div>
      <!-- Graph Popup -->
      <div id="graphPopup" class="graph-popup">
        <div class="graph-popup-content">
          <span class="close-graph">&times;</span>
          <h2>üìä Your Financial Overview</h2>
          <div class="charts-container">
            <canvas id="incomeExpenseChart"></canvas>
          </div>
        </div>
      </div>
      </section>
      <div class="summary-cards">
        <div class="card">
          <h3>Total Income</h3>
          <p id="total-income">‚Çπ0</p>
        </div>
        <div class="card">
          <h3>Total Expense</h3>
          <p id="total-expense">‚Çπ0</p>
        </div>
        <div class="card">
          <h3>Balance</h3>
          <p id="balance">‚Çπ0</p>
        </div>
      </div>
      <!-- Add Expense Form -->
      <div class="form-section">
        <h2>Add Records ‚ûï</h2>
        <form id="expense-form">
          <div class="input-group">
            <input type="text" id="title" placeholder=" " required>
            <label for="title">Title</label>
          </div>
          <div class="input-group">
            <input type="number" id="amount" placeholder=" " min="1">
            <label for="amount">Amount</label>
          </div>
          <div class="input-group">
            <select id="category" required>
              <option value="" disabled selected></option>
              <option value="Income">Income</option>
              <option value="Expense">Expense</option>
            </select>
            <label for="category">Category</label>
          </div>
          <div class="input-group date-wrapper">
            <input type="text" id="date" required readonly>
            <label for="date">Date</label>
            <span class="calendar-icon">üìÖ</span>
          </div>
          <button class="sbt">Submit</button>
          <div id="preview-modal" class="modal">
            <div class="modal-content">
              <h3>Confirm Expense</h3>
              <p>
                <strong>Title:</strong>
                <span id="preview-title"></span>
              </p>
              <p>
                <strong>Amount:</strong> ‚Çπ <span id="preview-amount"></span>
              </p>
              <p>
                <strong>Category:</strong>
                <span id="preview-category"></span>
              </p>
              <p>
                <strong>Date:</strong>
                <span id="preview-date"></span>
              </p>
              <div class="modal-actions">
                <button type="submit" id="confirm-btn">Confirm</button>
                <button type="button" id="cancel-btn">Cancel</button>
              </div>
            </div>
          </div>
        </form>
      </div>
      <!-- Expenses List -->
      <div class="list-section">
        <h2>Your Income & Expenses üíπ</h2>
        <div class="search-filter-bar">
          <div class="search-wrapper">
            <input type="text" id="searchInput" placeholder="üîç Search by title..." />
          </div>
          <select id="filterSelect">
            <option value="">All</option>
            <option value="Income">Income</option>
            <option value="Expense">Expense</option>
          </select>
          <div class="export-section">
            <button class="download-btn">‚¨á Download</button>
            <div class="export-dropdown">
              <a href="#" id="export-csv">Export CSV</a>
              <a href="#" id="export-pdf">Export PDF</a>
            </div>
          </div>
        </div>
        <ul id="expense-list"></ul>
      </div>
      <div id="delete-modal" class="modal">
        <div class="modal-content">
          <h3>
            <img width="25" height="25" src="https://img.icons8.com/glyph-neue/64/FA5252/trash.png" alt="trash" />Delete Record
          </h3>
          <p id="delete-text">Are you sure you want to delete this expense?</p>
          <div class="modal-actions">
            <button id="delete-confirm-btn">Yes, Delete</button>
            <button id="delete-cancel-btn">Cancel</button>
          </div>
        </div>
      </div>
      <!-- Update Form (hidden by default) -->
      <!-- Update Modal -->
      <div class="modal" id="update-modal">
        <div class="modal-content">
          <h3>Update Record ‚úèÔ∏è</h3>
          <form id="update-form">
            <input type="hidden" id="update-id">
            <div class="input-group">
              <input type="text" id="update-title" required>
              <label for="update-title">Title</label>
            </div>
            <div class="input-group">
              <input type="number" id="update-amount" required>
              <label for="update-amount">Amount</label>
            </div>
            <div class="input-group">
              <select id="update-category" required>
                <option value="" disabled selected style="color: black;">Select category</option>
                <option value="Income" style="color: black; font-weight: 600;">Income</option>
                <option value="Expense" style="color: black; font-weight: 600;">Expense</option>
              </select>
              <label for="update-category" style="color: black;">Category</label>
            </div>
            <div class="input-group">
              <input type="text" id="update-date" required readonly>
              <label for="update-date" style="color: black;">Date</label>
              <span class="calendar-icon">üìÖ</span>
            </div>
            <div class="modal-actions">
              <button type="submit" id="update-confirm-btn">Update</button>
              <button type="button" id="update-cancel-btn">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script src="script.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const username = localStorage.getItem("username");
        if (username) {
          document.getElementById("profile-avatar").textContent = username.charAt(0).toUpperCase();
        }
      });
      document.addEventListener("DOMContentLoaded", () => {
        const username = localStorage.getItem("username");
        if (username) {
          document.getElementById("profile-avatar").textContent = username.charAt(0).toUpperCase();
        }
      });
      // Show logout modal
      document.getElementById("logoutBtn").addEventListener("click", () => {
        document.getElementById("logout-modal").style.display = "flex";
      });
      // Cancel button hides modal
      document.getElementById("logout-cancel-btn").addEventListener("click", () => {
        document.getElementById("logout-modal").style.display = "none";
      });
      // Confirm button actually logs out
      document.getElementById("logout-confirm-btn").addEventListener("click", () => {
        localStorage.clear(); // clear user data
        window.location.href = "home.html"; // redirect to login
      });
    </script>
    <!-- AI Assistant Button & Modal (Injected by assistant) -->
    <style>
      /* Siri-like glowing border effect for main .container (uses existing .container element) */
      .ai-siri-active {
        filter: blur(0px);
        /* only blurs container, not the whole page */
        transition: filter 0.3s ease;
      }

      .ai-siri-active::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 20px;
        background: linear-gradient(270deg,
            #ff3cac,
            #784ba0,
            #2b86c5,
            #00c3ff,
            #ffff1c,
            #ff3cac);
        background-size: 400% 400%;
        animation: gradientFlowAI 6s ease infinite;
        -webkit-mask: radial-gradient(farthest-side, rgba(0, 0, 0, 0) 82%, rgba(0, 0, 0, 0.6) 90%, rgba(0, 0, 0, 1) 100%);
        mask: radial-gradient(farthest-side, rgba(0, 0, 0, 0) 50%, rgba(0, 0, 0, 0.6) 120%, rgba(0, 0, 0, 1) 150%);
        opacity: 0.6;
        pointer-events: none;
        z-index: 5;
      }

      @keyframes gradientFlowAI {
        20% {
          background-position: 0% 10%;
        }

        50% {
          background-position: 10% 20%;
        }

        70% {
          background-position: 0% 20%;
        }
      }

      /* Floating AI button */
      #ai-btn {
        position: fixed;
        right: 30px;
        bottom: 26px;
        width: 64px;
        height: 64px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #6ee7b7, #3b82f6);
        box-shadow: 0 12px 30px rgba(59, 131, 246, 0.338);
        cursor: pointer;
        z-index: 10050;
        transition: transform .14s ease, box-shadow .14s ease, opacity .14s;
        border: none;
      }

      #ai-btn:active {
        transform: scale(.75);
      }

      #ai-btn:hover {
        transform: scale(1.1);
      }

      #ai-btn .icon {
        width: 30px;
        height: 28px;
        filter: drop-shadow(0 6px 12px rgba(59, 130, 246, 0.12));
      }

      /* small pulse while thinking */
      #ai-btn.pulse {
        animation: aiPulse 1s infinite;
      }

      @keyframes aiPulse {
        0% {
          box-shadow: 0 6px 30px rgba(59, 130, 246, 0.18);
          transform: scale(1);
        }

        100% {
          box-shadow: 0 20px 60px rgba(59, 130, 246, 0.06);
          transform: scale(1.15);
        }

        300% {
          box-shadow: 0 6px 30px rgba(59, 130, 246, 0.18);
          transform: scale(1);
        }
      }

      .ai-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.25);
        /* dark transparent overlay */
        backdrop-filter: blur(2px);
        /* blur background */
        -webkit-backdrop-filter: blur(3px);
        z-index: 10055;
        border-radius: inherit;
      }

      /* Liquid-glass modal */
      .ai-modal {
        position: fixed;
        right: 24px;
        bottom: 100px;
        width: 350px;
        max-width: calc(100% - 48px);
        background: rgba(255, 255, 255, 0.092);
        backdrop-filter: blur(12px) saturate(200%);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 14px;
        z-index: 10060;
        opacity: 0;
        transform: scale(0.2) translate(0, 20px);
        transition: transform 0.28s ease, opacity 0.28s ease;
        pointer-events: none;
        /* prevent clicks when hidden */
      }

      .ai-modal.show {
        transform: scale(1) translate(0, 0);
        opacity: 1;
        pointer-events: auto;
        /* allow interaction */
        animation: aiModalIn .28s ease;
      }

      @keyframes aiModalIn {
        from {
          transform: translateY(8px) scale(.98);
          opacity: 0
        }

        to {
          transform: translateY(0) scale(1);
          opacity: 1
        }
      }

      .ai-modal .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .ai-modal .title {
        font-weight: 700;
        font-size: 15px;
        color: #e6eef8;
      }

      .ai-modal .close-btn {
        background: transparent;
        border: none;
        color: #cbd5e1;
        font-size: 18px;
        cursor: pointer;
      }

      .ai-body {
        margin-top: 10px;
        max-height: 360px;
        overflow: auto;
        padding-right: 6px;
      }

      /* typing text area */
      .ai-message {
        margin: 8px 0;
        padding: 10px 12px;
        border-radius: 10px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
        border: 1px solid rgba(255, 255, 255, 0.03);
        color: #e6eef8;
        line-height: 1.45;
        font-size: 14px;
        white-space: pre-wrap;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      }

      /* small loader line */
      .ai-loader {
        height: 6px;
        width: 100%;
        border-radius: 6px;
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.12));
        overflow: hidden;
        position: relative;
      }

      .ai-loader::after {
        content: "";
        position: absolute;
        left: -30%;
        top: 0;
        height: 100%;
        width: 30%;
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.24));
        animation: loaderMove 1s linear infinite;
      }

      @keyframes loaderMove {
        to {
          left: 110%
        }
      }

      /* small meta line */
      .ai-meta {
        font-size: 12px;
        color: #9fb3d6;
        margin-top: 6px;
      }
    
/* Consent UI for AI modal */
.ai-cookie-consent {
  padding: 18px;
  max-width: 640px;
  line-height: 1.45;
  color: white;
}
.ai-cookie-consent .consent-actions { margin-top: 12px; display:flex; gap:10px; }
.ai-cookie-consent button { padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:white; cursor:pointer; color: black; }
.ai-disabled, .ai-error { padding:18px; max-width:640px; line-height:1.4; color: white; }
.ai-disabled h3, .ai-error h3 { margin:0 0 8px 0; }
</style>
    <div class="ai-overlay" id="ai-overlay"></div>
    <button id="ai-btn" aria-label="AI Insights">
      <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2a4 4 0 0 0-4 4v1H7a4 4 0 0 0 0 8h1v1a4 4 0 0 0 8 0v-1h1a4 4 0 0 0 0-8h-1V6a4 4 0 0 0-4-4z" fill="white" />
      </svg>
    </button>
    <div class="ai-modal" id="ai-modal" role="dialog" aria-hidden="true" aria-labelledby="ai-title">
      <div class="header">
        <div>
          <div class="title" id="ai-title">Assistant</div>
          <div class="ai-meta" id="ai-meta">Analyzing recent activity‚Ä¶</div>
        </div>
        <button class="close-btn" id="ai-close" title="Close">‚úï</button>
      </div>
      <div class="ai-body" id="ai-body">
        <!-- messages injected here -->
        <div class="ai-loader" id="ai-loader" style="margin-top:12px;"></div>
      </div>
    </div>
    <script>
      (function() {
        const aiBtn = document.getElementById('ai-btn');
        const modal = document.getElementById('ai-modal');
        const body = document.getElementById('ai-body');
        const closeBtn = document.getElementById('ai-close');
        const aiLoader = document.getElementById('ai-loader');
        const mainContainer = document.querySelector('.container') || document.body;
        const sleep = (ms) => new Promise(res => setTimeout(res, ms));
        // Show AI modal
        
// Consent-gated AI modal flow (added by assistant)
async function startAiFlow() {

          // 1Ô∏è‚É£ Blur main container & pulse AI button
          mainContainer.classList.add('ai-siri-active');
          aiBtn.classList.add('pulse');
          // 2Ô∏è‚É£ Show modal
          modal.classList.add('show');
          modal.setAttribute('aria-hidden', 'false');
          // 3Ô∏è‚É£ Clear body & show loader
          body.innerHTML = '';
          body.appendChild(aiLoader);
          // 4Ô∏è‚É£ Fetch AI insights (fallback if error)
          let insights = null;
          try {
            const token = localStorage.getItem('token');
            const headers = token ? {
              'Authorization': 'Bearer ' + token
            } : {};
            const userId = localStorage.getItem('userId');
            const baseUrl = "http://localhost:8081"; // change your backend URL
            const url = userId ? `${baseUrl}/api/ai/insights?userId=${encodeURIComponent(userId)}` : `${baseUrl}/api/ai/insights`;
            const res = await fetch(url, {
              headers
            });
            if (!res.ok) throw new Error('AI server responded ' + res.status);
            insights = await res.json();
          } catch (err) {
            console.warn('AI fetch failed, using fallback:', err);
            insights = {
              warnings: ["Your balance is running low. Plan essentials carefully."],
              suggestions: ["Consider reducing your food expenses ‚Äî they are ~45% of your income this month."],
              predictedExpenseNextMonth: 2300.5,
              predictedEndOfMonthBalance: -120.4,
              recurring: [{
                title: "rent",
                averageAmount: 8000,
                nextExpectedDate: "2025-10-01"
              }]
            };
          }
          // 5Ô∏è‚É£ Remove loader
          if (aiLoader.parentNode) aiLoader.parentNode.removeChild(aiLoader);
          // 6Ô∏è‚É£ Build messages array
          const messages = [];
          if (insights.warnings?.length) messages.push({
            text: insights.warnings.join('\n')
          });
          else messages.push({
            text: 'No immediate warnings. Your balance looks stable.'
          });
          if (insights.suggestions?.length) messages.push({
            text: insights.suggestions.join('\n')
          });
          if (insights.predictedExpenseNextMonth !== undefined) messages.push({
            text: `Predicted next-month expense: ‚Çπ${Math.round(insights.predictedExpenseNextMonth)}`
          });
          if (insights.predictedEndOfMonthBalance !== undefined) messages.push({
            text: `Predicted end-of-month balance: ‚Çπ${Math.round(insights.predictedEndOfMonthBalance)}`
          });
          if (insights.recurring?.length) messages.push({
            text: 'Recurring detected:\n' + insights.recurring.map(r => `${r.title} (~‚Çπ${Math.round(r.averageAmount)}) expected ${r.nextExpectedDate}`).join('\n')
          });
          // 7Ô∏è‚É£ Render messages with typewriter effect
          await renderTypewriter(messages, body);
        
}

aiBtn.addEventListener('click', async () => {
  try {
    const consent = localStorage.getItem('aiModalCookieConsent');
    if (consent === null) {
      // Ask for consent inside the AI modal
      mainContainer.classList.add('ai-siri-active');
      aiBtn.classList.add('pulse');
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
      body.innerHTML = '';
      const consentDiv = document.createElement('div');
      consentDiv.className = 'ai-cookie-consent';
      consentDiv.innerHTML = `
        <h3>AI Assistant Consent</h3>
        <p>The AI assistant can analyze your expense records to provide personalized insights and send in-app alerts. This requires storing a local consent flag (no external cookies are set by this app). Do you allow the AI assistant to access your expense data?</p>
        <div class="consent-actions">
          <button id="ai-consent-allow">Allow</button>
          <button id="ai-consent-deny">Deny</button>
        </div>
        <p style="font-size:0.85em;margin-top:8px;color:#666">You can change this later from the AI settings.</p>
      `;
      body.appendChild(consentDiv);
      document.getElementById('ai-consent-allow').addEventListener('click', async () => {
        localStorage.setItem('aiModalCookieConsent', 'true');
        await startAiFlow();
      });
      document.getElementById('ai-consent-deny').addEventListener('click', () => {
        localStorage.setItem('aiModalCookieConsent', 'false');
        body.innerHTML = '';
        const disabled = document.createElement('div');
        disabled.className = 'ai-disabled';
        disabled.innerHTML = `
          <h3>AI Assistant Disabled</h3>
          <p>You denied consent. The AI assistant will not access or track your expense records.</p>
          <div style="margin-top:12px;"><button id="ai-cookie-settings">Change Settings</button></div>
        `;
        body.appendChild(disabled);
        document.getElementById('ai-cookie-settings').addEventListener('click', () => {
          localStorage.removeItem('aiModalCookieConsent');
          // re-open consent flow
          aiBtn.click();
        });
      });
    } else if (consent === 'true') {
      await startAiFlow();
    } else {
      // consent === 'false' -> open modal with disabled message and option to change
      mainContainer.classList.add('ai-siri-active');
      aiBtn.classList.add('pulse');
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
      body.innerHTML = '';
      const disabled = document.createElement('div');
      disabled.className = 'ai-disabled';
      disabled.innerHTML = `
        <h3>AI Assistant Disabled</h3>
        <p>You previously denied consent. The AI assistant will not access or track your records.</p>
        <div style="margin-top:12px;"><button id="ai-cookie-settings">Change Settings</button></div>
      `;
      body.appendChild(disabled);
      document.getElementById('ai-cookie-settings').addEventListener('click', () => {
        localStorage.removeItem('aiModalCookieConsent');
        aiBtn.click();
      });
    }
  } catch (err) {
    console.error('AI consent flow error', err);
    // fallback: open modal without tracking
    mainContainer.classList.add('ai-siri-active');
    aiBtn.classList.add('pulse');
    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
    body.innerHTML = '<div class="ai-error"><h3>AI Error</h3><p>Could not start AI assistant.</p></div>';
  }
});
;
        // Close modal
        closeBtn.addEventListener('click', () => {
          // Animate modal out
          modal.classList.remove('show');
          modal.setAttribute('aria-hidden', 'true');
          mainContainer.classList.remove('ai-siri-active');
          aiBtn.classList.remove('pulse');
        });
        // Typewriter rendering
        async function renderTypewriter(messages, container) {
          for (const msg of messages) {
            const el = document.createElement('div');
            el.className = 'ai-message';
            container.appendChild(el);
            await typeText(msg.text, el);
            await sleep(400);
          }
          const meta = document.createElement('div');
          meta.className = 'ai-meta';
          meta.textContent = 'Tip: click again to refresh insights.';
          container.appendChild(meta);
          container.scrollTop = container.scrollHeight;
        }
        async function typeText(text, el) {
          const lines = text.split('\n');
          el.textContent = '';
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            for (let j = 0; j < line.length; j++) {
              el.textContent += line.charAt(j);
              await sleep(24 + Math.random() * 30);
            }
            if (i < lines.length - 1) {
              el.textContent += '\n';
              await sleep(200);
            }
          }
        }
      })();
    </script>
    <!-- End AI Assistant Injection -->
  </body>
</html>
